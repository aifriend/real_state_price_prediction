<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.service.TrainService &mdash; Real State Price Prediction 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=01f34227"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Real State Price Prediction
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">real_state_price_prediction</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Real State Price Prediction</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.service.TrainService</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.service.TrainService</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">gensim.models</span> <span class="kn">import</span> <span class="n">Word2Vec</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>

<span class="kn">from</span> <span class="nn">src.service.DataService</span> <span class="kn">import</span> <span class="n">DataService</span>
<span class="kn">from</span> <span class="nn">src.service.EmbeddingService</span> <span class="kn">import</span> <span class="n">EmbeddingService</span>
<span class="kn">from</span> <span class="nn">src.service.RentalLogger</span> <span class="kn">import</span> <span class="n">logger</span>


<div class="viewcode-block" id="TrainService">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService">[docs]</a>
<span class="k">class</span> <span class="nc">TrainService</span><span class="p">:</span>

<div class="viewcode-block" id="TrainService.rmse">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.rmse">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rmse</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Root Mean Squared Error (RMSE) between the true and predicted values.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: object</span>
<span class="sd">            y_true (array-like): True values.</span>
<span class="sd">            y_pred (array-like): Predicted values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: RMSE value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> Root Mean Squared Error (RMSE): </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="TrainService.mape">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.mape">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mape</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Mean Absolute Percentage Error (MAPE) between the true and predicted values.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: object</span>
<span class="sd">            y_true (array-like): True values.</span>
<span class="sd">            y_pred (array-like): Predicted values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: MAPE value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_true</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> Mean Absolute Percentage Error (MAPE): </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="TrainService.r2">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.r2">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">r2</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the R-squared (R²) value between the true and predicted values.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: object</span>
<span class="sd">            y_true (array-like): True values.</span>
<span class="sd">            y_pred (array-like): Predicted values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: R-squared value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> R-squared (R²): </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="TrainService.pre_process_for">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.pre_process_for">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pre_process_for</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pre-process</span>

<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Drop meaningless columns</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;street&#39;</span><span class="p">,</span> <span class="s1">&#39;neighbourhood_cleansed&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;neighbourhood_group_cleansed&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span>
                         <span class="p">],</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Convert objects columns to category if necessary</span>
        <span class="c1"># The categorical features have to be converted internally to</span>
        <span class="c1"># numerical features for efficient modeling</span>
        <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
            <span class="c1"># Apply LabelEncoder to the categorical column</span>
            <span class="n">encoded_categories</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="n">category_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">encoded_categories</span><span class="p">))</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoded_categories</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> ==&gt; &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Apply label encoder with label &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">category_mapping</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># drop less significance features</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
                 <span class="mi">23</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
                 <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">]],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># X and y</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Split the data into training and testing sets</span>
        <span class="n">Xtr</span><span class="p">,</span> <span class="n">Xts</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">yts</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xtr</span><span class="p">,</span> <span class="n">Xts</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">yts</span></div>


    <span class="c1"># Train</span>
<div class="viewcode-block" id="TrainService.train_review_sentiment_analysis">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.train_review_sentiment_analysis">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">train_review_sentiment_analysis</span><span class="p">(</span><span class="n">rev_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In this method, I perform sentiment analysis on the reviews with these steps:</span>
<span class="sd">        1) We have a list of review texts without any sentiment labels.</span>
<span class="sd">        2) We tokenize the reviews by splitting them into words.</span>
<span class="sd">        3) We train a Word2Vec model on the tokenized reviews to learn word embeddings.</span>
<span class="sd">        4) We generate review embeddings by averaging the word embeddings for each review.</span>
<span class="sd">        5) We perform clustering using the KMeans algorithm on the review embeddings. Here, we specify the number of clusters as 2, assuming we want to group the reviews into two sentiment clusters (positive and negative).</span>
<span class="sd">        6) We evaluate the clustering performance using the silhouette score, which measures how well the reviews are clustered.</span>
<span class="sd">        7) We print the reviews along with their assigned cluster labels.</span>
<span class="sd">        8) We predict the cluster for a new review by tokenizing it, generating its embedding, and using the trained KMeans model.</span>

<span class="sd">        In this unsupervised approach, we don&#39;t have explicit sentiment labels. Instead, we rely on the clustering algorithm to group similar reviews together based on their embeddings. The assumption is that reviews with similar sentiments will have similar embeddings and will be clustered together.</span>
<span class="sd">        Note that the interpretation of the clusters as positive or negative sentiment may require manual inspection of the reviews within each cluster. Additionally, the optimal number of clusters may vary depending on the data and the desired granularity of sentiment analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            rev_df: reviews dataframe</span>
<span class="sd">            project_dir: project directory</span>
<span class="sd">            parent: parent id</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reviews</span> <span class="o">=</span> <span class="n">rev_df</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span>

        <span class="c1"># Tokenize the reviews</span>
        <span class="n">tokenized_reviews</span> <span class="o">=</span> <span class="p">[</span><span class="n">review</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">review</span> <span class="ow">in</span> <span class="n">reviews</span><span class="p">]</span>

        <span class="c1"># Train a Word2Vec model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Word2Vec</span><span class="p">(</span>
            <span class="n">tokenized_reviews</span><span class="p">,</span> <span class="n">vector_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">DataService</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">apex</span><span class="o">=</span><span class="s1">&#39;review_train_sentiment_analysis&#39;</span><span class="p">)</span>

        <span class="c1"># Generate review embeddings by averaging word embeddings</span>
        <span class="n">review_embeddings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">review</span> <span class="ow">in</span> <span class="n">tokenized_reviews</span><span class="p">:</span>
            <span class="n">review_embedding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">wv</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">review</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">wv</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">review_embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">review_embedding</span><span class="p">)</span>

        <span class="c1"># Perform clustering using KMeans</span>
        <span class="n">num_clusters</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">num_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">review_embeddings</span><span class="p">)</span>

        <span class="c1"># Evaluate clustering performance using silhouette score</span>
        <span class="n">silhouette_avg</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">review_embeddings</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Silhouette Score: </span><span class="si">{</span><span class="n">silhouette_avg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print the reviews and their assigned cluster labels</span>
        <span class="k">for</span> <span class="n">review</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reviews</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review: </span><span class="si">{</span><span class="n">review</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster Label: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Predict the cluster for a new review</span>
        <span class="n">new_review</span> <span class="o">=</span> <span class="s2">&quot;The room was spacious and clean, but the staff was rude.&quot;</span>
        <span class="n">new_review_tokens</span> <span class="o">=</span> <span class="n">new_review</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">new_review_embedding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">wv</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">new_review_tokens</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">wv</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_review_cluster</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">new_review_embedding</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New Review: </span><span class="si">{</span><span class="n">new_review</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predicted Cluster: </span><span class="si">{</span><span class="n">new_review_cluster</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrainService.train_reviews_by_score">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.train_reviews_by_score">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">train_reviews_by_score</span><span class="p">(</span><span class="n">rev_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
            <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">EmbeddingService</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The following code is used for text clustering and documents embedding. We want to represent reviews</span>
<span class="sd">        as vectors representation to be able to apply clustering algorithms to detect topics. Reviews are</span>
<span class="sd">        usually short sentences, thus, we should look for a suitable embedding approach for this situation</span>
<span class="sd">        like Sentence Transformers with BERT or Glove.</span>

<span class="sd">        We analyzed the relationship between the description of each listing and its price,</span>
<span class="sd">        and proposed a text-based price recommendation system called TAPE to recommend a reasonable price</span>
<span class="sd">        for newly added listings</span>

<span class="sd">        Args:</span>
<span class="sd">            rev_df: reviews dataframe</span>
<span class="sd">            project_dir: project directory</span>
<span class="sd">            parent: parent id</span>

<span class="sd">        Returns:</span>
<span class="sd">            classifier: classifier</span>
<span class="sd">            emb_service: embedding service</span>
<span class="sd">            X_test: test data</span>
<span class="sd">            y_test: test labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transform text to an embedding vector space&quot;</span><span class="p">)</span>
        <span class="n">emb_service</span> <span class="o">=</span> <span class="n">EmbeddingService</span><span class="p">()</span>
        <span class="n">listings_reviews_df</span> <span class="o">=</span> <span class="n">emb_service</span><span class="o">.</span><span class="n">get_embeddings</span><span class="p">(</span><span class="n">rev_df</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Split the data into training and testing sets&quot;</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">listings_reviews_df</span><span class="p">[</span><span class="s1">&#39;comments_emb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">listings_reviews_df</span><span class="p">[</span><span class="s1">&#39;review_scores_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">embeddings</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Train a logistic regression model using embeddings&quot;</span><span class="p">)</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">DataService</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span>
            <span class="n">classifier</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">apex</span><span class="o">=</span><span class="s1">&#39;review_train_score_str&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">emb_service</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span></div>


<div class="viewcode-block" id="TrainService.xgboost_tuning">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.xgboost_tuning">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">xgboost_tuning</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">XGBRegressor</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The chosen model was an XGBoost regression model with the following hyperparameters:</span>
<span class="sd">        Best hyperparameters:</span>
<span class="sd">        colsample_bytree: 1.0</span>
<span class="sd">        gamma: 0</span>
<span class="sd">        learning_rate: 0.1</span>
<span class="sd">        max_depth: 5</span>
<span class="sd">        min_child_weight: 3</span>
<span class="sd">        n_estimators: 400</span>
<span class="sd">        subsample: 0.9</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train: training data</span>
<span class="sd">            y_train: training labels</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">hyperparameter_grid_search</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">XGBRegressor</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Hyperparameter Tuning</span>

<span class="sd">            Identified XGBoost and Gradient Boosting as the top two performers for hyperparameter tuning.</span>
<span class="sd">            Employed grid search with 5-fold cross-validation to find the best hyperparameter combinations.</span>
<span class="sd">            Selected the model that demonstrated the best performance on the validation data.</span>
<span class="sd">            XGBoost Hyperparameter Tuning:</span>
<span class="sd">            Hyperparameter      Explanation                                                 Values</span>
<span class="sd">            n_estimators	    Number of trees	                                            [100, 200, 300, 400, 500]</span>
<span class="sd">            max_depth	        Maximum depth of each tree	                                [3, 4, 5]</span>
<span class="sd">            subsample	        Fraction of samples used for fitting each tree	            [0.8, 0.9, 1.0]</span>
<span class="sd">            colsample_bytree	Fraction of features used for fitting each tree	            [0.8, 0.9, 1.0]</span>
<span class="sd">            learning_rate	    Rate at which the model adapts during training	            [0.1, 0.01, 0.001]</span>
<span class="sd">            min_child_weight	Minimum sum of instance weight (hessian) needed in a child	[1, 2, 3]</span>
<span class="sd">            gamma	            Minimum loss reduction required when splitting a node	    [0, 0.1, 0.2]</span>

<span class="sd">            Args:</span>
<span class="sd">                X: training data</span>
<span class="sd">                y: training labels</span>

<span class="sd">            Returns:</span>
<span class="sd">                best_model_: best XGBRegressor model</span>
<span class="sd">                best_score_: best score</span>
<span class="sd">                best_params_: best dictionary of hyperparameters</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Create the XGBRegressor model</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">()</span>

            <span class="c1"># Define the cross-validation strategy</span>
            <span class="n">cv</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

            <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span>
                <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                <span class="s1">&#39;min_child_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing grid search...&quot;</span><span class="p">)</span>
            <span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
                <span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="n">best_model_</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="k">return</span> <span class="n">best_model_</span><span class="p">,</span> <span class="o">-</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="p">,</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>

        <span class="n">best_model</span><span class="p">,</span> <span class="n">best_score</span><span class="p">,</span> <span class="n">best_param</span> <span class="o">=</span> <span class="n">hyperparameter_grid_search</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Train the best model on the entire dataset</span>
        <span class="n">best_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_score</span><span class="p">,</span> <span class="n">best_param</span></div>


<div class="viewcode-block" id="TrainService.train">
<a class="viewcode-back" href="../../../src.service.html#src.service.TrainService.TrainService.train">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">XGBRegressor</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train the model</span>

<span class="sd">        Baseline Models</span>
<span class="sd">        Implemented five machine learning models with baseline parameter configurations and</span>
<span class="sd">        evaluated model performance on the validation data based on root mean squared error (RMSE),</span>
<span class="sd">        mean absolute percentage error (MAPE), and R-squared (R²).</span>

<span class="sd">        Model	                RMSE	MAPE	R²</span>
<span class="sd">        Linear Regression       407     151     0.05</span>
<span class="sd">        Decision Tree           388     77      0.13</span>
<span class="sd">        Xgboost                 331     110     0.36</span>
<span class="sd">        Gradient Boosting       341     105     0.33</span>
<span class="sd">        Random Forest           353     80      0.28</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train: training data</span>
<span class="sd">            X_test: test data</span>
<span class="sd">            y_train: training labels</span>
<span class="sd">            y_test: test labels</span>
<span class="sd">            project_dir: project directory</span>

<span class="sd">        Returns:</span>
<span class="sd">            XGBRegressor: trained model</span>
<span class="sd">            List: list of X values for training</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># feature Scaling</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">rescaled_x_train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">rescaled_x_test</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Baseline Models</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># linear regression</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescaled_x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred_lr</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">rescaled_x_test</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_lr</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">mape</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_lr</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">r2</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_lr</span><span class="p">)</span>
        <span class="n">DataService</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">apex</span><span class="o">=</span><span class="s1">&#39;price_train&#39;</span><span class="p">)</span>

        <span class="c1"># Decision Tree</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">min_samples_split</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescaled_x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred_tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">rescaled_x_test</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_tree</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">mape</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_tree</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">r2</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_tree</span><span class="p">)</span>
        <span class="n">DataService</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">apex</span><span class="o">=</span><span class="s1">&#39;price_train&#39;</span><span class="p">)</span>

        <span class="c1"># Xgboost</span>
        <span class="n">xgb</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span>
            <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">min_child_weight</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">subsample</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescaled_x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred_xgb</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">rescaled_x_test</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">xgb</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_xgb</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">mape</span><span class="p">(</span><span class="n">xgb</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_xgb</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">r2</span><span class="p">(</span><span class="n">xgb</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_xgb</span><span class="p">)</span>
        <span class="n">DataService</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">xgb</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">apex</span><span class="o">=</span><span class="s1">&#39;price_train&#39;</span><span class="p">)</span>

        <span class="c1"># Gradient Boosting</span>
        <span class="n">boost</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">boost</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescaled_x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred_boost</span> <span class="o">=</span> <span class="n">boost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">rescaled_x_test</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">boost</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_boost</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">mape</span><span class="p">(</span><span class="n">boost</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_boost</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">r2</span><span class="p">(</span><span class="n">boost</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_boost</span><span class="p">)</span>
        <span class="n">DataService</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">boost</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">apex</span><span class="o">=</span><span class="s1">&#39;price_train&#39;</span><span class="p">)</span>

        <span class="c1"># Random Forest</span>
        <span class="n">forest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescaled_x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred_forest</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">rescaled_x_test</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">forest</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_forest</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">mape</span><span class="p">(</span><span class="n">forest</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_forest</span><span class="p">)</span>
        <span class="n">TrainService</span><span class="o">.</span><span class="n">r2</span><span class="p">(</span><span class="n">forest</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_forest</span><span class="p">)</span>
        <span class="n">DataService</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">forest</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">apex</span><span class="o">=</span><span class="s1">&#39;price_train&#39;</span><span class="p">)</span>

        <span class="c1"># Feature importance</span>
        <span class="c1"># Plot feature importance</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="c1"># for i, v in enumerate(importance):</span>
        <span class="c1">#     logger.info(&#39;feature: %d, score: %.5f&#39; % (i, v))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">importance</span><span class="p">))],</span> <span class="n">importance</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;A barplot showing the significance of each feature&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">xgb</span><span class="p">,</span> <span class="n">rescaled_x_train</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Jose Lopez.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>